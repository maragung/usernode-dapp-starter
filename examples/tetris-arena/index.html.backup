<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tetris Arena</title>
  <script src="/usernode-bridge.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      color-scheme: light dark;
      --bg: #0b0f16;
      --fg: #e7edf7;
      --muted: #a8b3c7;
      --card: #141b26;
      --card-hover: #1a2332;
      --border: rgba(255,255,255,0.12);
      --accent: #6ea8fe;
      --danger: #ff6b6b;
      --ok: #5dd39e;
      --gold: #facc15;
      --tetrI: #00f0f1;
      --tetrJ: #0000f0;
      --tetrL: #f0a000;
      --tetrO: #f0f000;
      --tetrU: #00f0a0;
      --tetrS: #00f000;
      --tetrT: #a000f0;
      --tetrZ: #f00000;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8f9fa;
        --fg: #0b1220;
        --muted: #5a6b7d;
        --card: #ffffff;
        --card-hover: #f5f6f8;
        --border: rgba(15,23,42,0.1);
        --accent: #2563eb;
        --danger: #dc2626;
        --ok: #059669;
        --gold: #d97706;
      }
    }
    html {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      height: 100dvh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden;
    }
    main {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: linear-gradient(135deg, var(--card) 0%, var(--card-hover) 100%);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 0 1 auto;
    }
    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1 1 auto;
      justify-content: flex-end;
    }
    .user-pill {
      background: var(--border);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s;
    }
    .user-pill:hover {
      background: rgba(255,255,255,0.16);
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAIN CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .game-container {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      overflow: auto;
    }
    /* Desktop: side-by-side */
    @media (min-width: 768px) {
      .game-container {
        grid-template-columns: 1fr 320px;
      }
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GAME BOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .game-board-wrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 0;
    }
    .game-board {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 1px;
      width: fit-content;
      max-height: 100%;
    }
    .game-cell {
      width: 30px;
      height: 30px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 2px;
      transition: background-color 0.05s;
    }
    .game-cell.active {
      background: var(--accent);
      box-shadow: 0 0 8px rgba(110, 168, 254, 0.5);
      border-color: var(--accent);
    }
    .game-cell.I { background: var(--tetrI); border-color: var(--tetrI); }
    .game-cell.J { background: var(--tetrJ); border-color: var(--tetrJ); }
    .game-cell.L { background: var(--tetrL); border-color: var(--tetrL); }
    .game-cell.O { background: var(--tetrO); border-color: var(--tetrO); }
    .game-cell.U { background: var(--tetrU); border-color: var(--tetrU); }
    .game-cell.S { background: var(--tetrS); border-color: var(--tetrS); }
    .game-cell.T { background: var(--tetrT); border-color: var(--tetrT); }
    .game-cell.Z { background: var(--tetrZ); border-color: var(--tetrZ); }
    .game-cell.ghost {
      opacity: 0.3;
      background: var(--border);
      border-style: dashed;
    }
    /* Responsive: smaller cells on mobile */
    @media (max-width: 480px) {
      .game-cell {
        width: 24px;
        height: 24px;
      }
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 100%;
      overflow-y: auto;
    }
    .sidebar-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      min-width: 0;
    }
    .panel-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 8px;
    }
    .next-piece-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      justify-content: center;
    }
    .next-piece-cell {
      width: 28px;
      height: 28px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 2px;
    }
    .next-piece-cell.active {
      background: var(--accent);
      border-color: var(--accent);
    }
    .stats {
      display: grid;
      gap: 8px;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .stat-label {
      color: var(--muted);
    }
    .stat-value {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--fg);
    }
    .stat-value.highlight {
      color: var(--accent);
      font-size: 14px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .btn {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid;
      background: transparent;
      color: var(--fg);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .btn-primary {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
    }
    .btn-secondary {
      border-color: var(--border);
      color: var(--fg);
    }
    .btn-secondary:hover:not(:disabled) {
      background: var(--border);
    }
    .btn-danger {
      border-color: var(--danger);
      color: var(--danger);
    }
    .btn-danger:hover:not(:disabled) {
      background: var(--danger);
      color: #fff;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 12px;
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .leaderboard {
      max-height: 200px;
      overflow-y: auto;
    }
    .leaderboard-entry {
      display: grid;
      grid-template-columns: 24px 1fr 1fr;
      gap: 8px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    .leaderboard-entry:last-child {
      border-bottom: none;
    }
    .leaderboard-entry.my-rank {
      background: rgba(110, 168, 254, 0.1);
      padding: 8px;
      margin: 0 -4px;
      border-radius: 6px;
    }
    .entry-rank {
      font-weight: 700;
      color: var(--accent);
      text-align: center;
    }
    .entry-name {
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 11px;
    }
    .entry-name.you {
      color: var(--fg);
      font-weight: 600;
    }
    .entry-score {
      font-weight: 700;
      color: var(--fg);
      font-variant-numeric: tabular-nums;
      text-align: right;
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .modal h2 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 700;
    }
    .modal p {
      margin: 0 0 16px;
      color: var(--muted);
      line-height: 1.5;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    .modal-actions .btn {
      flex: 1;
    }
    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--fg);
      font-size: 14px;
      margin-bottom: 12px;
    }
    .modal-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MOBILE CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mobile-controls {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    @media (max-width: 768px) {
      .mobile-controls {
        display: flex;
      }
      .game-container {
        grid-template-columns: 1fr;
      }
    }
    .mobile-dpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      width: 180px;
      margin: 0 auto;
    }
    .dpad-btn {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-hover);
      color: var(--fg);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.1s;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    .dpad-btn:active {
      background: var(--accent);
      transform: scale(0.95);
    }
    .dpad-btn.action-btn {
      background: var(--accent);
      color: #fff;
    }
    .dpad-btn.action-btn:active {
      background: var(--danger);
    }
    .dpad-spacer {
      visibility: hidden;
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATUS MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-bar {
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 10px 16px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .status-bar.ok {
      color: var(--ok);
    }
    .status-bar.error {
      color: var(--danger);
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tx-progress {
      width: 100%;
      margin: 12px 0;
    }
    .tx-progress-track {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: var(--border);
      overflow: hidden;
    }
    .tx-progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 2px;
      background: var(--accent);
      transition: width 0.4s ease-out, background-color 0.4s ease;
    }
    .tx-progress-fill.ok {
      background: var(--ok);
    }
    .tx-progress-fill.warn {
      background: #e6a817;
    }
    .tx-progress-fill.err {
      background: var(--danger);
    }
    .tx-progress-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: center;
    }
    .tx-progress-label.warn {
      color: #e6a817;
    }
    .tx-progress-label.err {
      color: var(--danger);
    }
    .tx-progress.hide {
      display: none;
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SCROLLBAR STYLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }
  </style>
</head>
<body>
  <main>
    <div class="header">
      <div class="header-left">
        <h1>ðŸŽ® Tetris Arena</h1>
      </div>
      <div class="header-right">
        <div class="user-pill" id="userPill" title="Click to set username">
          <span id="userDisplay">user_loading</span>
        </div>
      </div>
    </div>

    <div class="game-container">
      <div class="game-board-wrapper">
        <div class="game-board" id="gameBoard"></div>
      </div>

      <div class="sidebar">
        <!-- Next Piece -->
        <div class="sidebar-panel">
          <div class="panel-title">Next Piece</div>
          <div class="next-piece-container" id="nextPieceContainer"></div>
        </div>

        <!-- Stats -->
        <div class="sidebar-panel">
          <div class="panel-title">Stats</div>
          <div class="stats">
            <div class="stat">
              <span class="stat-label">Score</span>
              <span class="stat-value highlight" id="scoreValue">0</span>
            </div>
            <div class="stat">
              <span class="stat-label">Level</span>
              <span class="stat-value" id="levelValue">1</span>
            </div>
            <div class="stat">
              <span class="stat-label">Lines</span>
              <span class="stat-value" id="linesValue">0</span>
            </div>
            <div class="stat">
              <span class="stat-label">Personal Best</span>
              <span class="stat-value" id="bestValue">0</span>
            </div>
            <div class="stat">
              <span class="stat-label">My Rank</span>
              <span class="stat-value" id="myRankValue">-</span>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div class="sidebar-panel">
          <div class="panel-title">Controls</div>
          <div class="controls">
            <button class="btn btn-primary" id="startBtn">Start Game</button>
            <button class="btn btn-secondary" id="pauseBtn" disabled>Pause</button>
            <button class="btn btn-secondary" id="resumeBtn" disabled>Resume</button>
            <button class="btn btn-secondary" id="profileBtn">My Profile</button>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="sidebar-panel">
          <div class="panel-title">Top Scores</div>
          <div class="leaderboard" id="leaderboard"></div>
        </div>

        <!-- Mobile controls -->
        <div class="mobile-controls">
          <div class="mobile-dpad">
            <button class="dpad-btn dpad-spacer" disabled></button>
            <button class="dpad-btn" id="btnRotate" data-action="rotate">â†»</button>
            <button class="dpad-btn dpad-spacer" disabled></button>
            <button class="dpad-btn" id="btnLeft" data-action="left">â—€</button>
            <button class="dpad-btn action-btn" id="btnDrop" data-action="drop">â†“</button>
            <button class="dpad-btn" id="btnRight" data-action="right">â–¶</button>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar" id="statusBar">Ready to play</div>
  </main>

  <!-- Modals -->
  <div class="modal-overlay" id="gameOverModal">
    <div class="modal">
      <h2>Game Over!</h2>
      <p id="gameOverMessage"></p>
      <div class="tx-progress hide" id="txProgress">
        <div class="tx-progress-track"><div class="tx-progress-fill"></div></div>
        <div class="tx-progress-label">Sending...</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="saveScoreBtn">Save to Chain</button>
        <button class="btn btn-secondary" id="playAgainBtn">Play Again</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <h2>My Profile</h2>
      <div style="background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: var(--muted);">Wallet Address</span>
        </div>
        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px; font-family: monospace; color: var(--muted); word-break: break-all;" id="profileAddress"></div>
      </div>
      <form id="usernameForm" onsubmit="return false">
        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; color: var(--muted); font-weight: 600; margin-bottom: 4px; display: block;">Display Name</label>
          <input type="text" class="modal-input" id="usernameInput" maxlength="20" placeholder="Enter username" />
          <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">Your address suffix will be added automatically</div>
        </div>
      </form>
      <div class="tx-progress hide" id="usernameProgress">
        <div class="tx-progress-track"><div class="tx-progress-fill"></div></div>
        <div class="tx-progress-label">Saving...</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="saveUsernameBtn">Save Username</button>
        <button class="btn btn-secondary" id="closeProfileBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* STANDARD DAPP HELPERS (Copy-paste from AGENTS.md)        */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function parseMemo(m) {
      if (m == null) return null;
      try { return JSON.parse(String(m)); } catch (_) { return null; }
    }

    function extractTimestamp(tx) {
      const candidates = [tx.timestamp_ms, tx.created_at, tx.createdAt, tx.timestamp, tx.time];
      for (const v of candidates) {
        if (typeof v === "number" && Number.isFinite(v))
          return v < 10_000_000_000 ? v * 1000 : v;
        if (typeof v === "string" && v.trim()) {
          const t = Date.parse(v);
          if (!Number.isNaN(t)) return t;
        }
      }
      return null;
    }

    function normalizeTx(tx) {
      if (!tx || typeof tx !== "object") return null;
      return {
        id:     tx.tx_id || tx.id || tx.txid || tx.hash || null,
        from:   tx.from_pubkey || tx.from || tx.source || null,
        to:     tx.destination_pubkey || tx.to || tx.destination || null,
        amount: tx.amount || null,
        memo:   tx.memo != null ? String(tx.memo) : null,
        ts:     extractTimestamp(tx) || Date.now(),
      };
    }

    function parseAppTx(rawTx) {
      const tx = normalizeTx(rawTx);
      if (!tx || !tx.from || !tx.to || tx.to !== APP_PUBKEY) return null;
      const memo = parseMemo(tx.memo);
      if (!memo || memo.app !== "tetrisarena") return null;
      return { tx, memo };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* TETRIS GAME CONFIG                                        */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const APP_PUBKEY = window.localStorage.getItem("tetris:app_pubkey") || "ut1_tetrisarena_default_pubkey";
    const TX_SEND_OPTS = { timeoutMs: 90000, pollIntervalMs: 1500 };
    const GRID_WIDTH = 10;
    const GRID_HEIGHT = 20;
    const BASE_TICK_MS = 800;

    /* Tetromino shapes (row, col offsets from pivot) */
    const TETROMINOES = {
      I: { color: 'I', blocks: [[0,0], [0,1], [0,2], [0,3]] },
      J: { color: 'J', blocks: [[0,0], [1,0], [1,1], [1,2]] },
      L: { color: 'L', blocks: [[0,2], [1,0], [1,1], [1,2]] },
      O: { color: 'O', blocks: [[0,0], [0,1], [1,0], [1,1]] },
      U: { color: 'U', blocks: [[0,0], [0,2], [1,0], [1,1], [1,2]] },
      S: { color: 'S', blocks: [[0,1], [0,2], [1,0], [1,1]] },
      T: { color: 'T', blocks: [[0,1], [1,0], [1,1], [1,2]] },
      Z: { color: 'Z', blocks: [[0,0], [0,1], [1,1], [1,2]] },
    };

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* GLOBAL STATE                                             */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let gameState = {
      grid: Array(GRID_HEIGHT).fill(null).map(() => Array(GRID_WIDTH).fill(null)),
      currentPiece: null,
      nextPiece: null,
      score: 0,
      level: 1,
      lines: 0,
      gameOver: false,
      paused: false,
      running: false,
      currentUserAddress: null,
      usernames: {},
      leaderboard: [],
      myRank: null,
    };

    let myUserAddress = null;
    let personalBest = parseInt(localStorage.getItem("tetris:personalBest") || "0", 10);

    let gameLoopTimeout = null;
    let statusMessage = "Ready to play";

    /* Progress bar state */
    const TX_PB_EXPECTED_S = 30;
    const TX_PB_WARN_S = 45;
    const TX_PB_ERR_S = 90;
    let _pbRaf = null;
    let _pbStart = 0;

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* DOM ELEMENTS                                              */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const domBoard = document.getElementById('gameBoard');
    const domNextPiece = document.getElementById('nextPieceContainer');
    const domScore = document.getElementById('scoreValue');
    const domLevel = document.getElementById('levelValue');
    const domLines = document.getElementById('linesValue');
    const domBest = document.getElementById('bestValue');
    const domMyRank = document.getElementById('myRankValue');
    const domLeaderboard = document.getElementById('leaderboard');
    const domStatus = document.getElementById('statusBar');
    const domUserPill = document.getElementById('userPill');
    const domUserDisplay = document.getElementById('userDisplay');

    const domStartBtn = document.getElementById('startBtn');
    const domPauseBtn = document.getElementById('pauseBtn');
    const domResumeBtn = document.getElementById('resumeBtn');
    const domProfileBtn = document.getElementById('profileBtn');

    const domGameOverModal = document.getElementById('gameOverModal');
    const domGameOverMsg = document.getElementById('gameOverMessage');
    const domSaveScoreBtn = document.getElementById('saveScoreBtn');
    const domPlayAgainBtn = document.getElementById('playAgainBtn');
    const domTxProgress = document.getElementById('txProgress');

    const domProfileModal = document.getElementById('profileModal');
    const domProfileAddress = document.getElementById('profileAddress');
    const domUsernameInput = document.getElementById('usernameInput');
    const domSaveUsernameBtn = document.getElementById('saveUsernameBtn');
    const domCloseProfileBtn = document.getElementById('closeProfileBtn');
    const domUsernameProgress = document.getElementById('usernameProgress');

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* PROGRESS BAR FUNCTIONS                                    */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function pbPercent(s) {
      if (s <= TX_PB_EXPECTED_S) {
        const t = s / TX_PB_EXPECTED_S;
        return 95 * (1 - Math.pow(1 - t, 3));
      }
      return 95 + 5 * (1 - Math.exp(-(s - TX_PB_EXPECTED_S) / 120));
    }

    function pbApply(el, pct, s) {
      if (!el) return;
      const fill = el.querySelector('.tx-progress-fill');
      const label = el.querySelector('.tx-progress-label');
      if (fill) {
        fill.style.width = pct + '%';
        fill.className = 'tx-progress-fill' +
          (s >= TX_PB_ERR_S ? ' err' : s >= TX_PB_WARN_S ? ' warn' : '');
      }
      if (label) {
        if (s >= TX_PB_ERR_S) {
          label.textContent = 'Taking longer than expected; check Discord';
          label.className = 'tx-progress-label err';
        } else if (s >= TX_PB_WARN_S) {
          label.textContent = 'Taking longer than expected';
          label.className = 'tx-progress-label warn';
        } else {
          label.textContent = 'Sending...';
          label.className = 'tx-progress-label';
        }
      }
    }

    function startProgressBar(el) {
      stopProgressBar();
      if (!el) return;
      el.classList.remove('hide');
      const f = el.querySelector('.tx-progress-fill');
      const l = el.querySelector('.tx-progress-label');
      if (f) { f.style.width = '0%'; f.className = 'tx-progress-fill'; }
      if (l) { l.textContent = 'Sending...'; l.className = 'tx-progress-label'; }
      _pbStart = performance.now();
      (function tick() {
        const s = (performance.now() - _pbStart) / 1000;
        pbApply(el, pbPercent(s), s);
        _pbRaf = requestAnimationFrame(tick);
      })();
    }

    function completeProgressBar(el) {
      stopProgressBar();
      if (!el) return;
      const f = el.querySelector('.tx-progress-fill');
      const l = el.querySelector('.tx-progress-label');
      if (f) { f.className = 'tx-progress-fill ok'; f.style.width = '100%'; }
      if (l) { l.textContent = 'Confirmed!'; l.className = 'tx-progress-label'; }
    }

    function stopProgressBar() {
      if (_pbRaf) { cancelAnimationFrame(_pbRaf); _pbRaf = null; }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* UI UPDATES                                                */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderBoard() {
      domBoard.innerHTML = '';
      for (let r = 0; r < GRID_HEIGHT; r++) {
        for (let c = 0; c < GRID_WIDTH; c++) {
          const cell = document.createElement('div');
          cell.className = 'game-cell';
          const val = gameState.grid[r][c];
          if (val) cell.classList.add(val);
          domBoard.appendChild(cell);
        }
      }
      renderCurrentPiece();
    }

    function renderCurrentPiece() {
      if (!gameState.currentPiece) return;
      const p = gameState.currentPiece;
      const tetro = TETROMINOES[p.type];
      tetro.blocks.forEach(([dr, dc]) => {
        const r = p.row + dr;
        const c = p.col + dc;
        if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH) {
          const idx = r * GRID_WIDTH + c;
          if (idx < domBoard.children.length) {
            domBoard.children[idx].classList.add(p.type, 'active');
          }
        }
      });
    }

    function renderNextPiece() {
      domNextPiece.innerHTML = '';
      if (!gameState.nextPiece) return;
      const tetro = TETROMINOES[gameState.nextPiece];
      const preview = Array(16).fill(null).map((_, i) => {
        const el = document.createElement('div');
        el.className = 'next-piece-cell';
        const r = Math.floor(i / 4);
        const c = i % 4;
        for (const [dr, dc] of tetro.blocks) {
          if (dr === r && dc === c) {
            el.classList.add(gameState.nextPiece, 'active');
          }
        }
        return el;
      });
      domNextPiece.append(...preview);
    }

    function updateStats() {
      domScore.textContent = gameState.score.toLocaleString();
      domLevel.textContent = gameState.level;
      domLines.textContent = gameState.lines;
      domBest.textContent = personalBest.toLocaleString();
    }

    function setStatus(msg, level = 'default') {
      statusMessage = msg;
      domStatus.textContent = msg;
      domStatus.className = 'status-bar';
      if (level === 'error') domStatus.classList.add('error');
      if (level === 'ok') domStatus.classList.add('ok');
    }

    async function renderLeaderboard() {
      try {
        const params = new URLSearchParams({ address: myUserAddress });
        const data = await fetch(`/__game/state?${params}`)
          .then(r => r.json()).catch(() => ({ leaderboard: [], usernames: {}, myRank: null }));
        gameState.leaderboard = data.leaderboard || [];
        gameState.usernames = data.usernames || {};
        gameState.myRank = data.myRank;

        domLeaderboard.innerHTML = '';
        gameState.leaderboard.slice(0, 10).forEach((entry, idx) => {
          const div = document.createElement('div');
          div.className = 'leaderboard-entry';
          if (entry.address === myUserAddress) div.classList.add('my-rank');

          const rank = document.createElement('div');
          rank.className = 'entry-rank';
          rank.textContent = (idx + 1);

          const name = document.createElement('div');
          name.className = 'entry-name';
          const displayName = gameState.usernames[entry.address] || 'user_' + entry.address.slice(-6);
          name.textContent = displayName;
          if (entry.address === myUserAddress) name.classList.add('you');

          const score = document.createElement('div');
          score.className = 'entry-score';
          score.textContent = entry.score.toLocaleString();

          div.append(rank, name, score);
          domLeaderboard.appendChild(div);
        });

        if (gameState.myRank !== null && gameState.myRank !== undefined) {
          domMyRank.textContent = '#' + gameState.myRank;
        } else {
          domMyRank.textContent = '-';
        }
      } catch (e) {
        console.error('Leaderboard error:', e);
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* GAME LOGIC                                                */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getRandomTetromino() {
      const keys = Object.keys(TETROMINOES);
      return keys[Math.floor(Math.random() * keys.length)];
    }

    function spawnPiece() {
      if (!gameState.nextPiece) {
        gameState.nextPiece = getRandomTetromino();
      }
      gameState.currentPiece = {
        type: gameState.nextPiece,
        row: 0,
        col: 3,
      };
      gameState.nextPiece = getRandomTetromino();
      renderNextPiece();

      if (!canPlace(gameState.currentPiece)) {
        endGame();
      }
    }

    function canPlace(piece) {
      const tetro = TETROMINOES[piece.type];
      return tetro.blocks.every(([dr, dc]) => {
        const r = piece.row + dr;
        const c = piece.col + dc;
        return r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH &&
               (gameState.grid[r][c] === null);
      });
    }

    function placePiece() {
      const tetro = TETROMINOES[gameState.currentPiece.type];
      tetro.blocks.forEach(([dr, dc]) => {
        const r = gameState.currentPiece.row + dr;
        const c = gameState.currentPiece.col + dc;
        gameState.grid[r][c] = gameState.currentPiece.type;
      });
    }

    function clearLines() {
      let clearedCount = 0;
      for (let r = GRID_HEIGHT - 1; r >= 0; r--) {
        if (gameState.grid[r].every(cell => cell !== null)) {
          gameState.grid.splice(r, 1);
          gameState.grid.unshift(Array(GRID_WIDTH).fill(null));
          clearedCount++;
        }
      }

      if (clearedCount > 0) {
        const linePoints = [0, 100, 300, 500, 800];
        const points = (linePoints[clearedCount] || 800) * gameState.level;
        gameState.score += points;
        gameState.lines += clearedCount;

        if (gameState.lines % 10 === 0) {
          gameState.level++;
        }
      }

      return clearedCount;
    }

    function moveLeft() {
      if (!gameState.running || gameState.paused || !gameState.currentPiece) return;
      gameState.currentPiece.col--;
      if (!canPlace(gameState.currentPiece)) {
        gameState.currentPiece.col++;
      }
      renderBoard();
    }

    function moveRight() {
      if (!gameState.running || gameState.paused || !gameState.currentPiece) return;
      gameState.currentPiece.col++;
      if (!canPlace(gameState.currentPiece)) {
        gameState.currentPiece.col--;
      }
      renderBoard();
    }

    function softDrop() {
      if (!gameState.running || gameState.paused || !gameState.currentPiece) return;
      gameState.currentPiece.row++;
      if (!canPlace(gameState.currentPiece)) {
        gameState.currentPiece.row--;
        placePiece();
        clearLines();
        spawnPiece();
      }
      renderBoard();
    }

    function rotatePiece() {
      if (!gameState.running || gameState.paused || !gameState.currentPiece) return;
      const tetro = TETROMINOES[gameState.currentPiece.type];
      const rotated = tetro.blocks.map(([r, c]) => [c, -r]);
      const old = TETROMINOES[gameState.currentPiece.type].blocks;
      TETROMINOES[gameState.currentPiece.type].blocks = rotated;

      if (!canPlace(gameState.currentPiece)) {
        TETROMINOES[gameState.currentPiece.type].blocks = old;
      }
      renderBoard();
    }

    function tick() {
      if (gameState.running && !gameState.paused) {
        softDrop();
      }
      scheduleNextTick();
    }

    function scheduleNextTick() {
      const tickMs = Math.max(100, BASE_TICK_MS - (gameState.level - 1) * 50);
      gameLoopTimeout = setTimeout(tick, tickMs);
    }

    function startGame() {
      gameState.grid = Array(GRID_HEIGHT).fill(null).map(() => Array(GRID_WIDTH).fill(null));
      gameState.currentPiece = null;
      gameState.nextPiece = null;
      gameState.score = 0;
      gameState.level = 1;
      gameState.lines = 0;
      gameState.gameOver = false;
      gameState.paused = false;
      gameState.running = true;

      domStartBtn.disabled = true;
      domPauseBtn.disabled = false;
      domResumeBtn.disabled = true;

      spawnPiece();
      renderBoard();
      updateStats();
      setStatus('Game running...');
      scheduleNextTick();
    }

    function pauseGame() {
      gameState.paused = true;
      domPauseBtn.disabled = true;
      domResumeBtn.disabled = false;
      setStatus('Game paused');
    }

    function resumeGame() {
      gameState.paused = false;
      domPauseBtn.disabled = false;
      domResumeBtn.disabled = true;
      setStatus('Game running...');
    }

    function endGame() {
      gameState.gameOver = true;
      gameState.running = false;
      clearTimeout(gameLoopTimeout);

      if (gameState.score > personalBest) {
        personalBest = gameState.score;
        localStorage.setItem('tetris:personalBest', personalBest);
      }

      domStartBtn.disabled = false;
      domPauseBtn.disabled = true;
      domResumeBtn.disabled = true;

      updateStats();
      domGameOverMsg.textContent = `Final Score: ${gameState.score.toLocaleString()} points | Level: ${gameState.level} | Lines: ${gameState.lines}`;
      domGameOverModal.classList.add('show');
      setStatus('Game over!', 'error');
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* BLOCKCHAIN INTERACTIONS                                   */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function saveScoreToChain() {
      const memo = JSON.stringify({
        app: 'tetrisarena',
        type: 'submit_score',
        score: gameState.score,
        level: gameState.level,
        lines: gameState.lines,
        address: myUserAddress,
      });

      if (memo.length > 1024) {
        setStatus('Payload too large', 'error');
        return;
      }

      try {
        startProgressBar(domTxProgress);
        domSaveScoreBtn.disabled = true;

        await sendTransaction(APP_PUBKEY, 1, memo, TX_SEND_OPTS);
        completeProgressBar(domTxProgress);
        setStatus('Score saved!', 'ok');

        setTimeout(() => {
          domGameOverModal.classList.remove('show');
          domTxProgress.classList.add('hide');
          renderLeaderboard();
        }, 1200);
      } catch (e) {
        stopProgressBar();
        domTxProgress.classList.add('hide');
        setStatus('Failed to save score: ' + (e.message || e), 'error');
      } finally {
        domSaveScoreBtn.disabled = false;
      }
    }

    async function saveUsernameToChain() {
      const username = domUsernameInput.value.trim();
      if (!username) {
        setStatus('Username cannot be empty', 'error');
        return;
      }

      const suffix = '_' + myUserAddress.slice(-6);
      const fullUsername = username + suffix;

      const memo = JSON.stringify({
        app: 'tetrisarena',
        type: 'set_username',
        username: fullUsername,
        address: myUserAddress,
      });

      if (memo.length > 1024) {
        setStatus('Username too long', 'error');
        return;
      }

      try {
        startProgressBar(domUsernameProgress);
        domSaveUsernameBtn.disabled = true;
        domSkipUsernameBtn.disabled = true;

        await sendTransaction(APP_PUBKEY, 1, memo, TX_SEND_OPTS);
        completeProgressBar(domUsernameProgress);
        setStatus('Username saved!', 'ok');

        setTimeout(() => {
          domUsernameModal.classList.remove('show');
          domUsernameProgress.classList.add('hide');
          renderLeaderboard();
        }, 1200);
      } catch (e) {
        stopProgressBar();
        domUsernameProgress.classList.add('hide');
        setStatus('Failed to save username: ' + (e.message || e), 'error');
      } finally {
        domSaveUsernameBtn.disabled = false;
        domSkipUsernameBtn.disabled = false;
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* EVENT LISTENERS                                           */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    domStartBtn.addEventListener('click', startGame);
    domPauseBtn.addEventListener('click', pauseGame);
    domResumeBtn.addEventListener('click', resumeGame);
    domProfileBtn.addEventListener('click', () => {
      domProfileAddress.textContent = myUserAddress;
      domUsernameInput.value = (gameState.usernames[myUserAddress] || '').replace(/_.{6}$/, '');
      domProfileModal.classList.add('show');
    });

    domSaveScoreBtn.addEventListener('click', saveScoreToChain);
    domPlayAgainBtn.addEventListener('click', () => {
      domGameOverModal.classList.remove('show');
      domTxProgress.classList.add('hide');
    });

    domUserPill.addEventListener('click', () => {
      domProfileAddress.textContent = myUserAddress;
      domUsernameInput.value = (gameState.usernames[myUserAddress] || '').replace(/_.{6}$/, '');
      domProfileModal.classList.add('show');
    });

    domSaveUsernameBtn.addEventListener('click', saveUsernameToChain);
    domCloseProfileBtn.addEventListener('click', () => {
      domProfileModal.classList.remove('show');
    });

    /* Keyboard controls */
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { e.preventDefault(); moveLeft(); }
      if (e.key === 'ArrowRight') { e.preventDefault(); moveRight(); }
      if (e.key === 'ArrowDown') { e.preventDefault(); softDrop(); }
      if (e.key === 'z' || e.key === 'Z') { e.preventDefault(); rotatePiece(); }
      if (e.key === ' ') { e.preventDefault(); if (gameState.running && gameState.paused) resumeGame(); else if (gameState.running) pauseGame(); }
    });

    /* Mobile controls */
    document.getElementById('btnLeft').addEventListener('click', moveLeft);
    document.getElementById('btnRight').addEventListener('click', moveRight);
    document.getElementById('btnDrop').addEventListener('click', softDrop);
    document.getElementById('btnRotate').addEventListener('click', rotatePiece);

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* INITIALIZATION                                            */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function init() {
      try {
        // Get user address
        myUserAddress = await getNodeAddress();
        localStorage.setItem('tetris:myAddress', myUserAddress);
        domUserDisplay.textContent = 'user_' + myUserAddress.slice(-6);

        // Load leaderboard
        await renderLeaderboard();

        setStatus('Ready to play', 'ok');
      } catch (e) {
        console.error('Init error:', e);
        setStatus('Failed to connect: ' + (e.message || e), 'error');
      }
    }

    // Refresh leaderboard every 4 seconds
    setInterval(renderLeaderboard, 4000);

    init();
  </script>
</body>
</html>
