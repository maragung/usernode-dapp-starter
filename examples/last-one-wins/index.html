<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Last One Wins</title>
  <script src="/usernode-bridge.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      color-scheme: light dark;
      --bg: #0b0f16; --fg: #e7edf7; --muted: #a8b3c7;
      --card: #141b26; --border: rgba(255,255,255,0.12);
      --accent: #6ea8fe; --danger: #ff6b6b; --ok: #5dd39e;
      --gold: #facc15; --gold-dim: rgba(250,204,21,0.15);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fb; --fg: #0b1220; --muted: #4b5568;
        --card: #ffffff; --border: rgba(15,23,42,0.12);
        --accent: #2563eb; --danger: #c81e1e; --ok: #0f766e;
        --gold: #ca8a04; --gold-dim: rgba(202,138,4,0.12);
      }
    }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI,
        Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--fg);
    }
    main {
      min-height: 100vh; min-height: 100dvh; width: 100%;
      display: flex; justify-content: center; padding: 16px;
    }
    .appCard {
      width: 100%; max-width: 520px; display: flex;
      flex-direction: column; gap: 0;
    }
    .header {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px 14px 0 0; padding: 18px 20px 14px;
      text-align: center;
    }
    .header h1 { margin: 0 0 2px; font-size: 22px; letter-spacing: 0.3px; }
    .header .round { font-size: 13px; color: var(--muted); }
    .content {
      flex: 1 1 auto; overflow-y: auto; min-height: 0;
      background: var(--card); border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      border-radius: 0 0 14px 14px; padding: 0 20px 20px;
    }

    /* Hero countdown */
    .hero { text-align: center; padding: 20px 0 16px; }
    .countdown {
      font-size: 48px; font-weight: 800; letter-spacing: -1px;
      font-variant-numeric: tabular-nums; color: var(--fg);
      line-height: 1.1;
    }
    .countdown.expired { color: var(--gold); }
    .countdown.waiting { color: var(--muted); font-size: 24px; font-weight: 500; }
    .hero-label { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .pot {
      font-size: 32px; font-weight: 700; margin: 12px 0 4px;
      color: var(--gold);
    }
    .pot-label { font-size: 13px; color: var(--muted); }
    .last-sender {
      margin-top: 10px; font-size: 13px; color: var(--muted);
      word-break: break-all;
    }
    .last-sender strong { color: var(--fg); font-weight: 600; }

    hr { border: 0; border-top: 1px solid var(--border); margin: 16px 0; }

    /* Send form */
    .section-title { font-size: 15px; font-weight: 600; margin: 0 0 10px; }
    .send-form { display: grid; gap: 10px; }
    .send-form label { display: grid; gap: 4px; }
    .send-form .field-label { font-size: 12px; color: var(--muted); }
    .send-form input {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: transparent;
      color: var(--fg); font-size: 16px; outline: none;
    }
    .send-form input:focus { border-color: var(--accent); }
    .send-form input[type="number"] {
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
    .btn {
      display: inline-block; padding: 12px 20px; border-radius: 10px;
      border: 1px solid var(--accent); background: var(--accent);
      color: #fff; font-size: 15px; font-weight: 600;
      cursor: pointer; text-align: center; transition: opacity 0.15s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled, .btn[aria-disabled="true"] {
      opacity: 0.45; cursor: not-allowed; pointer-events: none;
    }
    .error-msg {
      font-size: 13px; color: var(--danger); margin-top: 6px;
      min-height: 20px;
    }

    /* Progress bar */
    .tx-progress { width: 100%; margin: 8px 0 4px; }
    .tx-progress .tx-progress-track {
      width: 100%; height: 6px; border-radius: 3px;
      background: var(--border); overflow: hidden;
    }
    .tx-progress .tx-progress-fill {
      height: 100%; width: 0%; border-radius: 3px;
      background: var(--accent);
      transition: width 0.4s ease-out, background-color 0.4s ease;
    }
    .tx-progress .tx-progress-fill.ok { background: #6ef0a8; }
    .tx-progress .tx-progress-fill.warn { background: #e6a817; }
    .tx-progress .tx-progress-fill.err { background: var(--danger); }
    .tx-progress .tx-progress-label { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .tx-progress .tx-progress-label.warn { color: #e6a817; }
    .tx-progress .tx-progress-label.err { color: var(--danger); }
    .tx-progress.hide { display: none; }

    /* History */
    .entry-list { display: grid; gap: 6px; margin-top: 10px; }
    .entry-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; border-radius: 8px; font-size: 13px;
      border: 1px solid var(--border);
    }
    .entry-item .entry-from { color: var(--muted); font-size: 12px; }
    .entry-item .entry-amount { font-weight: 600; white-space: nowrap; }
    .entry-item .entry-time { font-size: 11px; color: var(--muted); }
    .entry-item.payout {
      background: var(--gold-dim); border-color: var(--gold);
    }
    .entry-item.payout .entry-amount { color: var(--gold); }

    .empty-state {
      text-align: center; color: var(--muted); padding: 20px 0;
      font-size: 14px;
    }

    /* Status */
    .status-bar {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 11px; color: var(--muted); padding: 8px 0 0;
    }
    .status-dot {
      display: inline-block; width: 7px; height: 7px;
      border-radius: 50%; margin-right: 4px; vertical-align: middle;
    }
    .status-dot.ok { background: var(--ok); }
    .status-dot.err { background: var(--danger); }
    .status-dot.pending { background: var(--gold); }

    /* Username pill */
    .username-pill {
      display: inline-block; padding: 4px 12px; border-radius: 16px;
      border: 1px solid var(--border); background: transparent;
      color: var(--accent); font-size: 13px; font-weight: 500;
      cursor: pointer; transition: border-color 0.15s, background 0.15s;
      margin-top: 6px;
    }
    .username-pill:hover { border-color: var(--accent); background: rgba(110,168,254,0.08); }
    .username-pill code { font-family: inherit; font-weight: 600; }

    /* Username edit panel */
    .username-panel { margin-top: 12px; display: none; }
    .username-panel.open { display: block; }
    .inputAffix {
      display: flex; align-items: center;
      border: 1px solid var(--border); border-radius: 10px;
      background: transparent;
    }
    .inputAffix:focus-within { border-color: var(--accent); }
    .inputAffixField {
      flex: 1 1 auto; min-width: 0; box-sizing: border-box;
      padding: 10px 12px; border: 0; outline: 0;
      background: transparent; color: var(--fg); font-size: 16px;
    }
    .inputAffixSuffix {
      padding: 0 12px 0 0; color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      white-space: nowrap; font-size: 14px;
    }
    .username-panel .row { display: flex; gap: 8px; margin-top: 8px; }
    .btn-sm {
      display: inline-block; padding: 8px 14px; border-radius: 8px;
      border: 1px solid var(--accent); background: var(--accent);
      color: #fff; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: opacity 0.15s;
    }
    .btn-sm:hover { opacity: 0.9; }
    .btn-sm:disabled { opacity: 0.45; cursor: not-allowed; }
    .btn-sm.secondary { background: transparent; color: var(--accent); }
    .hide { display: none !important; }
  </style>
</head>
<body>
  <main>
    <div class="appCard">
      <div class="header">
        <h1>Last One Wins</h1>
        <div class="round" id="roundLabel">Round 1</div>
        <button class="username-pill" id="usernamePill" type="button">
          <code id="usernameDisplay">(loading...)</code>
        </button>
        <div class="username-panel" id="usernamePanel">
          <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Set your display name</div>
          <div class="inputAffix">
            <input id="usernameInput" class="inputAffixField" maxlength="24" placeholder="username" />
            <span id="usernameSuffix" class="inputAffixSuffix">_??????</span>
          </div>
          <div class="row">
            <button class="btn-sm" id="saveUsernameBtn" type="button">Save</button>
            <button class="btn-sm secondary" id="cancelUsernameBtn" type="button">Cancel</button>
          </div>
          <div class="tx-progress hide" id="usernameTxProgress">
            <div class="tx-progress-track"><div class="tx-progress-fill"></div></div>
            <div class="tx-progress-label">Setting username...</div>
          </div>
        </div>
      </div>
      <div class="content">

        <!-- Hero: countdown + pot -->
        <div class="hero">
          <div class="countdown waiting" id="countdown">Waiting for first entry...</div>
          <div class="hero-label" id="countdownLabel"></div>
          <div class="pot" id="potDisplay">0</div>
          <div class="pot-label">tokens in the pot</div>
          <div class="last-sender" id="lastSender"></div>
        </div>

        <hr />

        <!-- Send form -->
        <div class="section-title">Send Tokens</div>
        <div class="send-form">
          <label>
            <span class="field-label">Amount</span>
            <input id="amountInput" type="number" min="1" value="1" />
          </label>
          <button class="btn" id="sendBtn">Send Tokens</button>
          <div class="error-msg" id="errorMsg"></div>
          <div class="tx-progress hide" id="txProgress">
            <div class="tx-progress-track"><div class="tx-progress-fill"></div></div>
            <div class="tx-progress-label">Sending...</div>
          </div>
        </div>

        <hr />

        <!-- History -->
        <div class="section-title">Recent Activity</div>
        <div class="entry-list" id="entryList">
          <div class="empty-state">No entries yet</div>
        </div>

        <div class="status-bar">
          <span><span class="status-dot pending" id="statusDot"></span><span id="statusText">connecting...</span></span>
          <span id="myAddress"></span>
        </div>
      </div>
    </div>
  </main>

  <script>
  (function () {
    /* ── Config ─────────────────────────────────────────────── */
    const GAME_POLL_MS = 4000;
    const TX_SEND_OPTS = { timeoutMs: 90000, pollIntervalMs: 1500 };
    const EXPLORER_BASE = window.location.origin + "/explorer-api";

    /* ── DOM refs ───────────────────────────────────────────── */
    const roundLabel = document.getElementById("roundLabel");
    const countdownEl = document.getElementById("countdown");
    const countdownLabel = document.getElementById("countdownLabel");
    const potDisplay = document.getElementById("potDisplay");
    const lastSenderEl = document.getElementById("lastSender");
    const amountInput = document.getElementById("amountInput");
    const sendBtn = document.getElementById("sendBtn");
    const errorMsg = document.getElementById("errorMsg");
    const txProgressEl = document.getElementById("txProgress");
    const entryList = document.getElementById("entryList");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const myAddressEl = document.getElementById("myAddress");
    const usernamePill = document.getElementById("usernamePill");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const usernamePanel = document.getElementById("usernamePanel");
    const usernameInput = document.getElementById("usernameInput");
    const usernameSuffixEl = document.getElementById("usernameSuffix");
    const saveUsernameBtn = document.getElementById("saveUsernameBtn");
    const cancelUsernameBtn = document.getElementById("cancelUsernameBtn");
    const usernameTxProgress = document.getElementById("usernameTxProgress");

    /* ── State ──────────────────────────────────────────────── */
    let sending = false;
    let gameData = null;
    let myAddress = null;
    let appPubkey = null;
    let myUsername = null;
    let usernameMap = {};

    /* ── Helpers ────────────────────────────────────────────── */
    function truncate(s, n) {
      if (!s || s.length <= n) return s || "";
      const h = Math.floor((n - 3) / 2);
      return s.slice(0, h) + "..." + s.slice(-h);
    }

    function formatCountdown(ms) {
      if (ms <= 0) return "00:00:00";
      const totalSec = Math.floor(ms / 1000);
      const d = Math.floor(totalSec / 86400);
      const h = Math.floor((totalSec % 86400) / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      const pad = (n) => String(n).padStart(2, "0");
      if (d > 0) return `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    function formatTime(ms) {
      if (!ms) return "";
      const d = new Date(ms);
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function showError(msg) {
      errorMsg.textContent = msg || "";
    }

    /* ── Username helpers ────────────────────────────────────── */
    function last6(addr) { return addr ? addr.slice(-6) : ""; }
    function usernameSuffix(addr) { return addr ? "_" + last6(addr) : "_??????"; }
    function defaultUsername(addr) { return addr ? "user_" + last6(addr) : "user"; }

    function displayName(pubkey) {
      if (!pubkey) return "???";
      if (usernameMap[pubkey]) return usernameMap[pubkey];
      return defaultUsername(pubkey);
    }

    function normalizeUsername(raw, addr) {
      const suffix = usernameSuffix(addr);
      const maxBase = Math.max(1, 24 - suffix.length);
      let v = String(raw || "").trim().replace(/[^\w-]/g, "");
      if (!v) return defaultUsername(addr);
      if (v.endsWith(suffix)) v = v.slice(0, -suffix.length);
      v = v.replace(/_[A-Za-z0-9]{6}$/, "");
      return (v.slice(0, maxBase) || "user") + suffix;
    }

    function setUsernameUi(name) {
      usernameDisplay.textContent = name || defaultUsername(myAddress);
    }

    /* ── Progress bar (reusable for any .tx-progress container) ── */
    const TX_PB_EXPECTED_S = 30, TX_PB_WARN_S = 45, TX_PB_ERR_S = 90;
    let _pbRaf = null, _pbStart = 0, _pbTarget = null;

    function pbPercent(s) {
      if (s <= TX_PB_EXPECTED_S) { const t = s / TX_PB_EXPECTED_S; return 95 * (1 - Math.pow(1 - t, 3)); }
      return 95 + 5 * (1 - Math.exp(-(s - TX_PB_EXPECTED_S) / 120));
    }
    function pbApply(el, pct, s, verb) {
      if (!el) return;
      const fill = el.querySelector(".tx-progress-fill");
      const label = el.querySelector(".tx-progress-label");
      if (fill) { fill.style.width = pct + "%"; fill.className = "tx-progress-fill" + (s >= TX_PB_ERR_S ? " err" : s >= TX_PB_WARN_S ? " warn" : ""); }
      if (label) {
        if (s >= TX_PB_ERR_S) { label.textContent = "Taking longer than it should; check Discord"; label.className = "tx-progress-label err"; }
        else if (s >= TX_PB_WARN_S) { label.textContent = "Taking longer than expected"; label.className = "tx-progress-label warn"; }
        else { label.textContent = verb || "Sending..."; label.className = "tx-progress-label"; }
      }
    }
    function startProgressBar(el, verb) {
      stopProgressBar();
      _pbTarget = el || txProgressEl;
      _pbTarget.classList.remove("hide");
      const f = _pbTarget.querySelector(".tx-progress-fill"), l = _pbTarget.querySelector(".tx-progress-label");
      if (f) { f.style.width = "0%"; f.className = "tx-progress-fill"; }
      if (l) { l.textContent = verb || "Sending..."; l.className = "tx-progress-label"; }
      _pbStart = performance.now();
      (function tick() { const s = (performance.now() - _pbStart) / 1000; pbApply(_pbTarget, pbPercent(s), s, verb); _pbRaf = requestAnimationFrame(tick); })();
    }
    function completeProgressBar(el) {
      stopProgressBar();
      const t = el || _pbTarget || txProgressEl;
      const f = t.querySelector(".tx-progress-fill"), l = t.querySelector(".tx-progress-label");
      if (f) { f.className = "tx-progress-fill ok"; f.style.width = "100%"; }
      if (l) { l.textContent = "Confirmed!"; l.className = "tx-progress-label"; }
      setTimeout(() => t.classList.add("hide"), 1200);
    }
    function stopProgressBar() { if (_pbRaf) { cancelAnimationFrame(_pbRaf); _pbRaf = null; } }

    function setSending(v, txSucceeded) {
      sending = !!v;
      sendBtn.disabled = !!v;
      amountInput.disabled = !!v;
      saveUsernameBtn.disabled = !!v;
      if (v) startProgressBar();
      else if (txSucceeded) completeProgressBar();
      else { stopProgressBar(); txProgressEl.classList.add("hide"); }
    }

    /* ── Render ─────────────────────────────────────────────── */
    function render() {
      if (!gameData) return;

      if (gameData.usernames) usernameMap = gameData.usernames;

      // Update own username from the server map
      if (myAddress && usernameMap[myAddress] && usernameMap[myAddress] !== myUsername) {
        myUsername = usernameMap[myAddress];
        setUsernameUi(myUsername);
      }

      roundLabel.textContent = "Round " + gameData.roundNumber;
      potDisplay.textContent = String(gameData.potBalance);

      if (!gameData.lastSender) {
        countdownEl.textContent = "Waiting for first entry...";
        countdownEl.className = "countdown waiting";
        countdownLabel.textContent = "";
        lastSenderEl.innerHTML = "";
      } else if (gameData.timerExpired) {
        countdownEl.textContent = "TIMER EXPIRED";
        countdownEl.className = "countdown expired";
        countdownLabel.textContent = gameData.payoutInProgress ? "Payout in progress..." : "Payout imminent!";
        lastSenderEl.innerHTML = "";
        const w = document.createElement("span");
        w.textContent = "Winner: ";
        const s = document.createElement("strong");
        s.textContent = displayName(gameData.lastSender);
        lastSenderEl.appendChild(w);
        lastSenderEl.appendChild(s);
      } else {
        countdownEl.textContent = formatCountdown(gameData.timeRemainingMs);
        countdownEl.className = "countdown";
        countdownLabel.textContent = "until pot is claimed";
        lastSenderEl.innerHTML = "";
        const w = document.createElement("span");
        w.textContent = "Last sender: ";
        const s = document.createElement("strong");
        s.textContent = displayName(gameData.lastSender);
        lastSenderEl.appendChild(w);
        lastSenderEl.appendChild(s);
      }

      // Entries + past rounds combined
      entryList.innerHTML = "";
      const items = [];

      for (const e of (gameData.entries || [])) {
        items.push({ type: "entry", from: e.from, amount: e.amount, ts: e.ts, txId: e.txId });
      }
      for (const r of (gameData.pastRounds || [])) {
        items.push({ type: "payout", from: r.winner, amount: r.amount, ts: r.payoutTs, round: r.round });
      }
      items.sort((a, b) => b.ts - a.ts);

      if (items.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No entries yet — be the first!";
        entryList.appendChild(empty);
        return;
      }

      for (const item of items.slice(0, 30)) {
        const el = document.createElement("div");
        el.className = "entry-item" + (item.type === "payout" ? " payout" : "");

        const left = document.createElement("div");
        const fromEl = document.createElement("div");
        fromEl.className = "entry-from";
        if (item.type === "payout") {
          fromEl.textContent = "Round " + item.round + " payout → " + displayName(item.from);
        } else {
          fromEl.textContent = displayName(item.from);
        }
        const timeEl = document.createElement("div");
        timeEl.className = "entry-time";
        timeEl.textContent = formatTime(item.ts);
        left.appendChild(fromEl);
        left.appendChild(timeEl);

        const amtEl = document.createElement("div");
        amtEl.className = "entry-amount";
        amtEl.textContent = (item.type === "payout" ? "+" : "") + item.amount;

        el.appendChild(left);
        el.appendChild(amtEl);
        entryList.appendChild(el);
      }
    }

    /* ── Countdown tick (1s local updates between polls) ───── */
    setInterval(() => {
      if (!gameData || !gameData.lastSender || gameData.timerExpired) return;
      if (gameData.timeRemainingMs != null && gameData.timeRemainingMs > 0) {
        gameData.timeRemainingMs = Math.max(0, gameData.timeRemainingMs - 1000);
        if (gameData.timeRemainingMs <= 0) gameData.timerExpired = true;
        countdownEl.textContent = formatCountdown(gameData.timeRemainingMs);
        if (gameData.timerExpired) {
          countdownEl.textContent = "TIMER EXPIRED";
          countdownEl.className = "countdown expired";
          countdownLabel.textContent = "Payout imminent!";
        }
      }
    }, 1000);

    /* ── Game state polling ─────────────────────────────────── */
    async function pollGameState() {
      try {
        const resp = await fetch("/__game/state");
        if (!resp.ok) throw new Error("status " + resp.status);
        gameData = await resp.json();
        if (!appPubkey && gameData.appPubkey) appPubkey = gameData.appPubkey;
        render();
        statusDot.className = "status-dot ok";
        statusText.textContent = "connected";
      } catch (e) {
        statusDot.className = "status-dot err";
        statusText.textContent = "connection error";
      }
    }

    /* ── Send handler ──────────────────────────────────────── */
    sendBtn.addEventListener("click", async () => {
      if (sending) return;
      showError("");

      const amount = parseInt(amountInput.value, 10);
      if (!amount || amount < 1) {
        showError("Enter an amount of at least 1.");
        return;
      }

      if (!appPubkey) {
        showError("Game not loaded yet — please wait.");
        return;
      }

      const memo = JSON.stringify({ app: "lastwin", type: "entry" });
      if (memo.length > 1024) {
        showError("Payload too large.");
        return;
      }

      try {
        setSending(true);
        const prevPot = gameData ? gameData.potBalance : 0;
        await window.sendTransaction(appPubkey, amount, memo, TX_SEND_OPTS);
        setSending(false, true);
        showError("");
        for (let i = 0; i < 5; i++) {
          await pollGameState();
          if (gameData && gameData.potBalance !== prevPot) break;
          await new Promise((r) => setTimeout(r, 2000));
        }
      } catch (e) {
        setSending(false, false);
        showError("Send failed: " + (e.message || e));
      }
    });

    /* ── Username flow ────────────────────────────────────────── */
    function openUsernamePanel() {
      if (sending) return;
      const suffix = usernameSuffix(myAddress);
      const full = myUsername || defaultUsername(myAddress);
      const base = full.endsWith(suffix) ? full.slice(0, -suffix.length) : full.replace(/_[A-Za-z0-9]{6}$/, "");
      usernameInput.value = base || "user";
      usernameSuffixEl.textContent = suffix;
      usernamePanel.classList.add("open");
    }

    function closeUsernamePanel() {
      usernamePanel.classList.remove("open");
      usernameTxProgress.classList.add("hide");
    }

    usernamePill.addEventListener("click", () => {
      if (usernamePanel.classList.contains("open")) closeUsernamePanel();
      else openUsernamePanel();
    });

    cancelUsernameBtn.addEventListener("click", closeUsernamePanel);

    saveUsernameBtn.addEventListener("click", async () => {
      if (sending || !appPubkey) return;
      const value = normalizeUsername(usernameInput.value, myAddress);
      if (!value) return;

      const memo = JSON.stringify({ app: "lastwin", type: "set_username", username: value });
      if (memo.length > 1024) { showError("Username too long."); return; }

      try {
        sending = true;
        saveUsernameBtn.disabled = true;
        cancelUsernameBtn.disabled = true;
        sendBtn.disabled = true;
        startProgressBar(usernameTxProgress, "Setting username...");

        await window.sendTransaction(appPubkey, 1, memo, TX_SEND_OPTS);

        myUsername = value;
        setUsernameUi(myUsername);
        completeProgressBar(usernameTxProgress);
        setTimeout(closeUsernamePanel, 1200);
        await pollGameState();
      } catch (e) {
        stopProgressBar();
        usernameTxProgress.classList.add("hide");
        showError("Username failed: " + (e.message || e));
      } finally {
        sending = false;
        saveUsernameBtn.disabled = false;
        cancelUsernameBtn.disabled = false;
        sendBtn.disabled = false;
      }
    });

    /* ── Init ──────────────────────────────────────────────── */
    async function init() {
      try {
        myAddress = await window.getNodeAddress();
        if (myAddress) {
          myAddressEl.textContent = truncate(myAddress, 16);
          setUsernameUi(defaultUsername(myAddress));
          usernameSuffixEl.textContent = usernameSuffix(myAddress);
        }
      } catch (_) {}

      // Wire up bridge's getTransactions to explorer if available
      // (skip in mock/local-dev mode so reads use mock endpoints)
      const mockEnabled = window.usernode && typeof window.usernode.isMockEnabled === "function"
        ? await window.usernode.isMockEnabled()
        : false;

      if (!mockEnabled) {
        try {
          const resp = await fetch(EXPLORER_BASE + "/active_chain");
          if (resp.ok) {
            const data = await resp.json();
            if (data && data.chain_id) {
              window.usernode = window.usernode || {};
              window.usernode.transactionsBaseUrl = EXPLORER_BASE + "/" + data.chain_id;
            }
          }
        } catch (_) {}
      }

      await pollGameState();
      setInterval(pollGameState, GAME_POLL_MS);
    }

    init();
  })();
  </script>
</body>
</html>
